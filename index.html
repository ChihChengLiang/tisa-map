<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>兩岸服務貿易協定災難圖</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />

    <!--[if lte IE 8]>
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.ie.css" />
    <![endif]-->
    
    <style type="text/css">
    html, body { height: 100% }
        body {
            padding: 0;
            margin: 0;
        }
    #map { 
        width: 100%;
        height: 100%;
        position: relative;
        }

    #gov-area {
        width: 100%;
        position: relative;
        padding-bottom: 100px;
    }

    #scroll-down {
        z-index: 1000;
        width: 400px;
        height: 50px;
        background-color: red;
        position: absolute;
        cursor: pointer;
        text-align: center;
        line-height: 50px;
        color: #FFF;
        font-size: 25px;
        bottom: 0px;
    }

    #count-down {
        z-index: 10000;
        position: absolute;
        right: 0px;
        bottom: 50px;
    }

    #join-reject {
        z-index: 10000;
        position: absolute;
        left: 0px;
    }


    </style>

    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-38980669-2', 'lijung.com');
        ga('send', 'pageview');
   </script>
    <link href="./src/css/l.geosearch.css" rel="stylesheet" />
    <link href="./src/css/main.css" rel="stylesheet" />
    <link rel="stylesheet" href="./src/css/scroll-top.css" />
    
</head>
<body>
    <a id="top"></a>

    <div id="map" >

        <div id="count-down">
            <div id="counter"></div>
            <div class="desc">
                <div>日</div>
                <div>時</div>
                <div>分</div>
                <div>秒</div>
            </div>
        </div>
        <div id="scroll-down">召喚我們台灣人的救星！</div>
    </div> <!-- /container -->

    <div id="gov-area">

        <div id="login_area">
            <div id="login_img">
            </div>
            <button id="logout">
                logout
            </button>
            <div id="upload_process">
            </div>
            <div> <!-- surround it with some container element -->
                <input type="file" id="avatar">
            </div>

        </div>

        <div id="login_list">
        </div>

        <div>
            <img src="./img/login-with-facebook.png" id="facebook_login"/>
            
            <img src="./img/login-with-twitter.png" id="twitter_login"/>
        </div>


        <div id="message"><a href="#top">回到災難圖</a></div>
    </div>

    <script src="http://code.jquery.com/jquery-1.8.3.min.js"  type="text/javascript"></script>
    <script src='https://cdn.firebase.com/v0/firebase.js'></script>
    <script type='text/javascript' src='https://cdn.firebase.com/v0/firebase-simple-login.js'></script>

    <script src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>
    <script src="./src/avatars.io.min.js"></script>
    <script src="./src/geosearch_js/l.control.geosearch.js"></script>
    <script src="./src/geosearch_js/l.geosearch.provider.openstreetmap.js"></script>
    <script src="./src/topojson.js"></script>
    <script src="./src/person_data.js"></script>
    <script src="./src/handlebars.js"></script>
    <script src="./src/jquery.countdown.js"></script>
    <script src="./src/scroll-top.js"></script>

    <script>

        var tisadb = new Firebase('https://tisa.firebaseIO.com');

        tisadb.auth('EymO4wmkV7dJBZgZq4sRo8lXAItLAJKHjaOWPShU', function(error, result) {
            if(error) {
                console.log("Login Failed!", error);
            } else {
                console.log('Authenticated successfully with payload:', result.auth);
                console.log('Auth expires at:', new Date(result.expires * 1000));
            }
        });

        var auth = new FirebaseSimpleLogin(tisadb, function(error, user) {
              if (error) {
                // an error occurred while attempting login
                console.log(error);
              } else if (user) {
                // user authenticated with Firebase
                $('#login_img').html('<img src="http://avatars.io/' + user.provider + '/' + user.username + '"/>' )
                var userRef = tisadb.child('users');

                peopleRef = userRef.child(user.id + '(' +  user.provider + ')');

                var email = user.email || ''
                    , provider = user.provider || ''
                    , id = user.id || ''
                    , displayName = user.displayName || ''
                    , username = user.username || ''

                peopleRef.set({
                    username: username,
                    displayName: displayName,
                    id: id,
                    provider: provider,
                    email: email,
                    avatar: "http://avatars.io/" + provider + '/' + username + "?size=medium"
                })

                console.log(user);
                
                $('#facebook_login').hide();
                $('#twitter_login').hide();
                $('#logout').show();
                $('#login_area').show();

              } else {
                // user is logged out
                $('#facebook_login').show();
                $('#twitter_login').show();
                $('#logout').hide();
                $('#login_area').hide();
              }
        });

        var userRef = new Firebase('https://tisa.firebaseIO.com/users');

        userRef.on('child_added', function(snapshot) {
          var personData = snapshot.val();
          $('#login_list').append('<img src="' + personData.avatar + '" width="50"/>');
        });

    </script>   

    <script src="./src/avatar-user.js"></script>
    <script src="./src/auth.js"></script>

    <script id="entry-template" type="text/x-handlebars-template">

        

        <div class="ly-person">
            <div class="unit" id="{{name}}">

                <p class="{{party}} kmt name">{{name}}</p>

                <div class="ly-person-left">
                    <img src="{{avatar}}?size=large" width="200"/>
                </div>

                <div class="ly-person-right">
                
                    <div class="ly-contact">
                        {{#each contact}}
                        <p>{{@key}}</p>
                            <ul> 
                            {{#if this.phone}}
                                <li class="phone">{{this.phone}}</li>
                            {{/if}}
                            {{#if this.address}}
                                <li class="address">{{this.address}}</li>
                            {{/if}}
                            {{#if this.fax}}
                                <li class="fax">{{this.fax}}</li>
                            {{/if}}
                            </ul>
                        {{/each}}
                    </div>
                
                </div>

                <div class="ly-person-clear">
                </div>

            </div>
        </div>

        
    </script>

    <script type="text/javascript">
    var geocoder;
    var field = new Field();

    $(function(){
        // 第一個倒數計時, 圖片來源為 images/digits.png
        // 倒數時間為 1 天 12 小時又 12 分 0 秒
        $('#counter').countdown({
            image: 'img/digits.png',
            startTime: '01:12:12:00'
        });
    });

    get_person(function() {

        var source   = $("#entry-template").html();
        var template = Handlebars.compile(source);
        for (var i = ly_arr.length - 1; i >= 0; i--) {
            if(ly_arr[i].party  === 'KMT') {
                ly_arr[i].party = '國民黨';
            }

            var html    = template(ly_arr[i]);
            $('#gov-area').append(html)
        };
        
    });
    

    function initialize () {

        $('#scroll-down').css('left', ($(window).width() / 2) - 200 + 'px')

        $('#scroll-top').css('left', ($(window).width() / 2) - 200 + 'px')

        map = L.map('map', {
            zoomControl: false,
            attributionControl: false
        });

        geocoder = new L.Control.GeoSearch({
            provider: new L.GeoSearch.Provider.OpenStreetMap()
        }).addTo(map);

        L.tileLayer('http://{s}.tile.cloudmade.com/f59941c17eda4947ae395e907fe531a3/997/256/{z}/{x}/{y}.png', {
        maxZoom: 18,
        }).addTo(map);

        var town_layer = L.geoJson(null, {
            style: {
                color: 'red',
                weight: 5,
                fill: 'red',
                opacity: 1,
                fillOpacity: 0.3
            },
            onEachFeature: function (feature, layer) {
                layer.bindPopup("<img src='" + feature.properties.avatar + "'/><br/>" + feature.properties.name + "<br/><a href='#" + feature.properties.name + "'>我要找他求救！</a>");
            }
        });

        $.getJSON('./json_data/tisa-ly-map.json', function (data) {
            var town_geojson = topojson.feature(data, data.objects["twVote1982.geo"]);
            town_layer.addData(town_geojson);
        });

        map.setView(['24', '121'], 7).addLayer(town_layer);

        map.addControl(new L.Control.Zoom({ position: 'bottomleft' }));

        // map.on('drag', function(e) {
        //     console.log(e.target._animateToCenter[0]);
        //     console.log(e.target._animateToCenter[1]); // e is an event object 

        //     mapServiceProvider(e.target._animateToCenter[0], e.target._animateToCenter[1]);
        // });

        // map.on('dragend', function(e) {
        //     console.log(e.target._animateToCenter[0]);
        //     console.log(e.target._animateToCenter[1]); 
        // });
        // 
        // 
        


    }

    function startLocate() {
        if (navigator.geolocation) {
        
            navigator.geolocation.getCurrentPosition(function(option) {
                field.setValue(option.coords.latitude, option.coords.longitude)
            }, function(error) {
                switch (error.code) {
                    case error.TIMEOUT:
                        alert('GPS 定位連線逾時，請手動輸入所在地');
                        break;
         
                    case error.POSITION_UNAVAILABLE:
                        alert('無法取得 GPS 定位，請手動輸入所在地');
                        break;
         
                    case error.PERMISSION_DENIED://拒絕
                        //alert('不允許 GPS 自動定位，請手動輸入所在地');
                        break;
         
                    case error.UNKNOWN_ERROR:
                        alert('不明的錯誤，請手動輸入所在地');
                        break;
                }
            })

        } else { // 不支援 HTML5 定位
 
            // 若支援 Google Gears
            if (window.google && google.gears) {
                try {
                      // 嘗試以 Gears 取得定位
                      var geo = google.gears.factory.create('beta.geolocation');
                      geo.getCurrentPosition(successCallback, errorCallback, { enableHighAccuracy: true,gearsRequestAddress: true });
                } catch(e){
                      alert("定位失敗，請手動輸入所在地");
                }
            }else{
                alert("不允許 GPS 自動定位，請手動輸入所在地");
            }

            function errorCallback(err) {
                var msg = '自動定位有誤，請手動輸入所在地<br>錯誤訊息：' + err.message;
                alert(msg);
            }
             
            // 成功取得 Gears 定位
            function successCallback(option) {
                  field.setValue(option.coords.latitude, option.coords.longitude);
            }



        }
         
    }


    function createMap (setplace) {
        map.setView(setplace, 13);


        L.marker(setplace).addTo(map)
        .bindPopup("<b>你現在在這！</b>").openPopup();

        
    }

    function Field(){
        var latitude 
        var longitude 
       
        this.getValue = function(){
            console.log(latitude)
            console.log(longitude)
            return [latitude, longitude];
        };
       
        this.setValue = function(lat_val, long_val){
            latitude = lat_val;
            longitude = long_val;
            createMap (this.getValue())
        };
    }

    initialize();
    startLocate();

    $('#scroll-down').click(function() {
      $("html, body").animate({ scrollTop: $(window).height() }, 1000);
    });


    </script>



    
</body>
</html>
