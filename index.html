
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>L.Geocoder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.ie.css" />
    <![endif]-->
    
    <style type="text/css">
    html, body { height: 100% }
        body {
            padding: 0;
            margin: 0;
        }
    #map { 
        width: 100%;
        height: 100%;
        float: left;
        }

 /*   #gov {
        width: 30%;
        height: 100%;
        float: right;
        color: #FFF;
    }*/


    </style>

    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-38980669-2', 'lijung.com');
        ga('send', 'pageview');
   </script>
    <link href="./src/css/l.geosearch.css" rel="stylesheet" />
    
</head>
<body>

    <div id="map" >
    </div> <!-- /container -->
    
    <script src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>
    <script src="http://code.jquery.com/jquery-1.8.3.min.js"  type="text/javascript"></script>
    <script src="./src/js/l.control.geosearch.js"></script>
    <script src="./src/js/l.geosearch.provider.openstreetmap.js"></script>
    <script src="src/topojson.js"></script>

    <script type="text/javascript">
    var geocoder;
    var field = new Field();

    function initialize () {

        map = L.map('map', {
            zoomControl: false,
            attributionControl: false
        });

        geocoder = new L.Control.GeoSearch({
            provider: new L.GeoSearch.Provider.OpenStreetMap()
        }).addTo(map);

        L.tileLayer('http://{s}.tile.cloudmade.com/f59941c17eda4947ae395e907fe531a3/997/256/{z}/{x}/{y}.png', {
        maxZoom: 18,
        styleId: 22677,
        }).addTo(map);

        var town_layer = L.geoJson(null, {
            style: {
                color: 'red',
                weight: 5,
                fillColor: 'red',
                opacity: 1,
                fillOpacity: 0.3
            }
        });
        
        $.getJSON('./json_data/tisa-ly-map.json', function (data) {
            var town_geojson = topojson.mesh(data, data.objects["twVote1982.geo"]);
            town_layer.addData(town_geojson);
        });

        map.setView(['24', '121'], 7).addLayer(town_layer);

        map.addControl(new L.Control.Zoom({ position: 'bottomleft' }));

        // map.on('drag', function(e) {
        //     console.log(e.target._animateToCenter[0]);
        //     console.log(e.target._animateToCenter[1]); // e is an event object 

        //     mapServiceProvider(e.target._animateToCenter[0], e.target._animateToCenter[1]);
        // });

        // map.on('dragend', function(e) {
        //     console.log(e.target._animateToCenter[0]);
        //     console.log(e.target._animateToCenter[1]); 
        // });
        // 
        // 
        


    }

    function startLocate() {
        if (navigator.geolocation) {
        
            navigator.geolocation.getCurrentPosition(function(option) {
                field.setValue(option.coords.latitude, option.coords.longitude)
            }, function(error) {
                switch (error.code) {
                    case error.TIMEOUT:
                        alert('GPS 定位連線逾時，請手動輸入所在地');
                        break;
         
                    case error.POSITION_UNAVAILABLE:
                        alert('無法取得 GPS 定位，請手動輸入所在地');
                        break;
         
                    case error.PERMISSION_DENIED://拒絕
                        //alert('不允許 GPS 自動定位，請手動輸入所在地');
                        break;
         
                    case error.UNKNOWN_ERROR:
                        alert('不明的錯誤，請手動輸入所在地');
                        break;
                }
            })

        } else { // 不支援 HTML5 定位
 
            // 若支援 Google Gears
            if (window.google && google.gears) {
                try {
                      // 嘗試以 Gears 取得定位
                      var geo = google.gears.factory.create('beta.geolocation');
                      geo.getCurrentPosition(successCallback, errorCallback, { enableHighAccuracy: true,gearsRequestAddress: true });
                } catch(e){
                      alert("定位失敗，請手動輸入所在地");
                }
            }else{
                alert("不允許 GPS 自動定位，請手動輸入所在地");
            }

            function errorCallback(err) {
                var msg = '自動定位有誤，請手動輸入所在地<br>錯誤訊息：' + err.message;
                alert(msg);
            }
             
            // 成功取得 Gears 定位
            function successCallback(option) {
                  field.setValue(option.coords.latitude, option.coords.longitude);
            }



        }
         
    }


    function createMap (setplace) {
        map.setView(setplace, 13);


        L.marker(setplace).addTo(map)
        .bindPopup("<b>你現在在這！</b>").openPopup();

        
    }

    function Field(){
        var latitude 
        var longitude 
       
        this.getValue = function(){
            console.log(latitude)
            console.log(longitude)
            return [latitude, longitude];
        };
       
        this.setValue = function(lat_val, long_val){
            latitude = lat_val;
            longitude = long_val;
            createMap (this.getValue())
        };
    }

    initialize();
    startLocate()

    </script>



    
</body>
</html>
