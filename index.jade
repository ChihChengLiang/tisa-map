!!! 5
html
    head
        meta(http-equiv='Content-Type', content='text/html; charset=utf-8')
        title 兩岸服務貿易協定災難圖
        meta(name='viewport', content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no')
        link(rel='stylesheet', href='http://cdn.leafletjs.com/leaflet-0.5/leaflet.css')
        //if lte IE 8
            link(rel='stylesheet', href='http://cdn.leafletjs.com/leaflet-0.5/leaflet.ie.css')
        link(href='./src/css/l.geosearch.css', rel='stylesheet')
        link(href='./src/css/main.css', rel='stylesheet')
        link(rel='stylesheet', href='./src/css/scroll-top.css')
        link(rel="stylesheet", href="./src/script/markercluster/MarkerCluster.Default.css")
        link(rel="stylesheet", href="./src/script/markercluster/MarkerCluster.css")
    body
        a#top

        // map container
        #map

            // for count down container
            #count-down
                #counter
                .desc
                    div 日
                    div 時
                    div 分
                    div 秒

            // scroll down area
            #scroll-down 召喚我們台灣人的救星！

        // container 
        input#usr_lat(type="hidden")
        input#usr_lng(type="hidden")

        // gov people area
        #gov-area
            #login_area
                #login_img
                button#logout
                    | logout
                #upload_process
                #avatar_uploader
                    // surround it with some container element 
                    input#avatar(type='file')
            #login_list
            div
                img#facebook_login(src='./img/login-with-facebook.png')
                img#twitter_login(src='./img/login-with-twitter.png')
            #message
                a(href='#top') 回到災難圖
        script(data-main = "/src/index", src='//cdnjs.cloudflare.com/ajax/libs/require.js/2.1.4/require.min.js');


        // script(src='http://code.jquery.com/jquery-1.8.3.min.js', type='text/javascript')
        // script(src='https://cdn.firebase.com/v0/firebase.js')
        // script(type='text/javascript', src='https://cdn.firebase.com/v0/firebase-simple-login.js')
        // script(src='http://cdn.leafletjs.com/leaflet-0.5/leaflet.js')
        // script(src='./src/avatars.io.min.js')
        // script(src='./src/geosearch_js/l.control.geosearch.js')
        // script(src='./src/geosearch_js/l.geosearch.provider.openstreetmap.js')
        // script(src='./src/topojson.js')
        // script(src='./src/person_data.js')
        // script(src='./src/handlebars.js')
        // script(src='./src/jquery.countdown.js')
        // script(src='./src/scroll-top.js')
        // script(type='text/javascript', src='./src/init.js')
        // script(src="./src/markercluster/leaflet.markercluster.js")
        script.

            // create firebase reference
            
            var tisadb = new Firebase('https://tisa.firebaseIO.com');
                tisadb.auth('EymO4wmkV7dJBZgZq4sRo8lXAItLAJKHjaOWPShU', function(error, result) {
                if(error) {

                    // create firebase reference error

                    console.log("Login Failed!", error);
                } else {

                    // successfully create firebase reference

                    console.log('Authenticated successfully with payload:', result.auth);
                    console.log('Auth expires at:', new Date(result.expires * 1000));
                }
            });

            // user login 


            var auth = new FirebaseSimpleLogin(tisadb, function(error, user) {

                if (error) {

                    // an error occurred while attempting login
                    console.log(error);

                } else if (user) {

                    // user authenticated with Firebase
                    console.log(user);

                    // display social network thumb while user login successfully
                    $('#login_img').html('<img src="http://avatars.io/' + user.provider + '/' + user.username + '/?size=medium"/>' );

                    // enter to 'users' child
                    var userRef = tisadb.child('users');

                    // enter to individual users
                    var peopleRef = userRef.child(user.id + '(' +  user.provider + ')');

                    // setup some variables before updating to database
                    var email = user.email || ''
                    , provider = user.provider || ''
                    , id = user.id || ''
                    , displayName = user.displayName || ''
                    , username = user.username || ''
                    , latlng = []

                    // make latitude, longtitude array

                    latlng.push($('#usr_lat').val());
                    latlng.push($('#usr_lng').val());

                    // update data to database
                    peopleRef.update({
                        username: username,
                        displayName: displayName,
                        id: id,
                        provider: provider,
                        email: email,
                        avatar: "http://avatars.io/" + provider + '/' + username + "?size=medium",
                        latlng: latlng
                    })

                    // upload participate image, if the image exist then update.
                    if(peopleRef.child('upload_img')) {
                        peopleRef.child('upload_img').on('value', function(snapshot){

                            $('#upload_process').html('<img src="' + snapshot.val() + '" width=100px/> 感謝你的參與～～你可以再重新上傳，我們只會使用你最新上傳的照片' );

                        })
                    }

                    // hide login button, show social images. If success.

                    $('#facebook_login').hide();
                    $('#twitter_login').hide();
                    $('#logout').show();
                    $('#login_area').show();

                } else {

                    // user is logged out

                    $('#facebook_login').show();
                    $('#twitter_login').show();
                    $('#logout').hide();
                    $('#login_area').hide();
                }
            });
                
            var userRef = new Firebase('https://tisa.firebaseIO.com/users');

            // all person's data to an array
            var peopleArr = [];
            console.log(L)

            // show up the people that have already login.
            userRef.on('child_added', function(snapshot) {

                // fetch personal data from firebase
                var personData = snapshot.val()
                , personArr = [];

                $('#login_list').append('<img src="' + personData.avatar + '" width="50"/>');

                personArr.push(personData.latlng[0]);
                personArr.push(personData.latlng[1]);
                personArr.push(personData.avatar);
                personArr.push(personData.displayName);

                // push person data to people array

                peopleArr.push(personArr)

                // marker cluster for users

                var markers = L.markerClusterGroup({ disableClusteringAtZoom: 17 });

                // loop through users
                for (var i = 0; i < peopleArr.length; i++) {
                    var a = peopleArr[i];
                    var title = a[2];
                    var name = a[3];
                    var lat_val = a[0] || 24;
                    var lng_val = a[1] || 121;
                    var marker = L.marker(L.latLng(lat_val, lng_val), { title: title });

                    // add popup
                    marker.bindPopup('<img src="' + title + '" width="50"><br>' + name);

                    // add new layer to map
                    markers.addLayer(marker);
                }

                map.addLayer(markers);
            });
        //- // script(src='./src/avatar-user.js')
        //- // script(src='./src/auth.js')

        // using handlebars to show up ly's info
        script#entry-template(type='text/x-handlebars-template').
            <div class="ly-person">
                <div class="unit" id="{{name}}">
                    <p class="{{party}} kmt name">{{name}}</p>
                    <div class="ly-person-left">
                        <img src="{{avatar}}?size=large" width="200"/>
                    </div>
                <div class="ly-person-right">
                    <div class="ly-contact">
                        {{#each contact}}
                        <p>{{@key}}</p>
                        <ul>
                            {{#if this.phone}}
                            <li class="phone">{{this.phone}}</li>
                            {{/if}}
                            {{#if this.address}}
                            <li class="address">{{this.address}}</li>
                            {{/if}}
                            {{#if this.fax}}
                            <li class="fax">{{this.fax}}</li>
                            {{/if}}
                        </ul>
                        {{/each}}
                    </div>
                </div>
                <div class="ly-person-clear">
                </div>
            </div>
        
